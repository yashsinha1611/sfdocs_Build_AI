"use strict";(self.webpackChunksf_documentation=self.webpackChunksf_documentation||[]).push([[9951],{3905:function(e,a,n){n.d(a,{Zo:function(){return c},kt:function(){return f}});var t=n(7294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function p(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=t.createContext({}),s=function(e){var a=t.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},c=function(e){var a=s(e.components);return t.createElement(l.Provider,{value:a},e.children)},m={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},d=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),d=s(n),f=r,g=d["".concat(l,".").concat(f)]||d[f]||m[f]||i;return n?t.createElement(g,o(o({ref:a},c),{},{components:n})):t.createElement(g,o({ref:a},c))}));function f(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var p={};for(var l in a)hasOwnProperty.call(a,l)&&(p[l]=a[l]);p.originalType=e,p.mdxType="string"==typeof e?e:r,o[1]=p;for(var s=2;s<i;s++)o[s]=n[s];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5018:function(e,a,n){n.r(a),n.d(a,{assets:function(){return c},contentTitle:function(){return l},default:function(){return f},frontMatter:function(){return p},metadata:function(){return s},toc:function(){return m}});var t=n(3117),r=n(102),i=(n(7294),n(3905)),o=["components"],p={},l="NodeJS tracing",s={unversionedId:"Tracing/nodejs",id:"Tracing/nodejs",title:"NodeJS tracing",description:"Available Platforms",source:"@site/docs/Tracing/nodejs.md",sourceDirName:"Tracing",slug:"/Tracing/nodejs",permalink:"/docs/Tracing/nodejs",editUrl:"https://github.com/ram-dot-kumar/SFwebsite.git/docs/Tracing/nodejs.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Ruby tracing",permalink:"/docs/Tracing/ruby"},next:{title:"C",permalink:"/docs/Tracing/csharp"}},c={},m=[{value:"Available Platforms",id:"available-platforms",level:4},{value:"Instances",id:"instances",level:2},{value:"Node.JS Express",id:"nodejs-express",level:3},{value:"Node.JS Script",id:"nodejs-script",level:3},{value:"Node.JS Sails",id:"nodejs-sails",level:3},{value:"Kubernetes",id:"kubernetes",level:2},{value:"Node.JS Express",id:"nodejs-express-1",level:3},{value:"Node.JS Sails",id:"nodejs-sails-1",level:3},{value:"Docker",id:"docker",level:2},{value:"Node.JS Express",id:"nodejs-express-2",level:3},{value:"Node.JS Sails",id:"nodejs-sails-2",level:3},{value:"ECS",id:"ecs",level:2},{value:"Node.JS Express",id:"nodejs-express-3",level:3},{value:"Node.JS Sails",id:"nodejs-sails-3",level:3},{value:"AWS Lambda",id:"aws-lambda",level:2},{value:"Log Correlation",id:"log-correlation",level:2},{value:"Adding custom Snappyflow logger for log correlation",id:"adding-custom-snappyflow-logger-for-log-correlation",level:3},{value:"Send log correlation data to snappyflow server",id:"send-log-correlation-data-to-snappyflow-server",level:2},{value:"<b> For Appliance </b>",id:"-for-appliance-",level:3},{value:"<b> For Kubernetes </b>",id:"-for-kubernetes-",level:3},{value:"Sample deployment file",id:"sample-deployment-file",level:3}],d={toc:m};function f(e){var a=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,t.Z)({},d,n,{components:a,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"nodejs-tracing"},"NodeJS tracing"),(0,i.kt)("h4",{id:"available-platforms"},"Available Platforms"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"nodejs#instances"},"Instances"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"nodejs#docker"},"Docker"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"nodejs#kubernetes"},"Kubernetes"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"nodejs#ecs"},"ECS"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"nodejs#aws-lambda"},"AWS Lambda"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"For Log Correlation, scroll to the bottom of this page or ",(0,i.kt)("a",{parentName:"strong",href:"#log-correlation"},"click here"))),(0,i.kt)("h2",{id:"instances"},"Instances"),(0,i.kt)("h3",{id:"nodejs-express"},"Node.JS Express"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0\nnpm install --save sf-apm-lib@^1.0.2\n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0"\n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"and run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies"))),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variable in ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," file and load it using ",(0,i.kt)("inlineCode",{parentName:"p"},"require('dotenv').config()")," and access it in code using ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.<ENV_VAR>"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib');\nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml. \n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n         serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n         serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n         globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n         verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n         active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n         stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n         captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n         metricsInterval: '0s',\n         usePathAsTransactionName: true\n    }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in add container section of task definitions. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html"},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in Snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to:"),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on left side bar   -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at:"),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))))),(0,i.kt)("h3",{id:"nodejs-script"},"Node.JS Script"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0  \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file"),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nlet projectName = <SF_PROJECT_NAME>; //replace with appropriate project name \nlet appName = <SF_APP_NAME>; //replace with appropriate application name \nlet profileKey = <SF_PROFILE_KEY>; //replace with key copied from SF profile\n\nvar sfObj = new Snappyflow(); \nsfObj.init(profileKey, projectName, appName); \nlet sfTraceConfig = sfObj.getTraceConfig(); \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm;\ntry { \n   apm = require('elastic-apm-node').start({ \n        serviceName: '<SERVICE_NAME>', // Specify service name for tracing \n        serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n        globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n        verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n         active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n        stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n        captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n         metricsInterval: '0s',\n         usePathAsTransactionName: true\n         \n    }) \n} catch (e) { \n    console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Create a custom transaction and span within transaction using following code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var trans = apm.startTransaction('json transaction', 'reference-app'); \nvar span = apm.startSpan('parse json'); \ntry { \n   JSON.parse('{\"app\": \"test\"}') \n} catch (e) { \n   apm.captureError(e); // Capture the error using apm.captureError(e) method.\n} \n \n// when we've processed, stop the custom span \nif (span) span.end() \n   trans.result = err ? 'error' : 'success'; \n// end the transaction \ntrans.end(); \n")),(0,i.kt)("p",{parentName:"li"},"For more info refer  "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-transactions.html"},"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-transactions.html")," "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-spans.html"},"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-spans.html")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Run you script using node ",(0,i.kt)("inlineCode",{parentName:"p"},"file_name.js")," you should see trace data in Snappyflow server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in Snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to: View dashboard -> Click on Tracing on left side bar   -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Refer sample script file at: "),(0,i.kt)("p",{parentName:"li"},"[https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-\t\texpress/node_trace_script.js]","(",(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-"},"https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-"),"\t\texpress/node_trace_script.js ) "))))),(0,i.kt)("h3",{id:"nodejs-sails"},"Node.JS Sails"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0  \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variable in .env file and load it using ",(0,i.kt)("inlineCode",{parentName:"p"},"require('dotenv').config()")," and access it in code using ",(0,i.kt)("inlineCode",{parentName:"p"},"process.env.<ENV_VAR>"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"globals.js")," present in config folder."),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using:  "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib');\n\nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n        serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n        serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n        globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n        verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n         active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n        stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n        captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n         metricsInterval: '0s',\n         usePathAsTransactionName: true\n    }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Attach apm object to globals \u2013 This is required so we can use apm variable in other files as part of global sails object. "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.globals = { \n   _: require('@sailshq/lodash'), \n   async: false, \n   models: true, \n   sails: true, \n   apm : apm, \n   logger: logger \n}; \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Also add middleware in ",(0,i.kt)("inlineCode",{parentName:"p"},"http.js")," file present in config folder. Which allows to instrument our code. "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.http = { \n   middleware: { \n      order: [ \n         'elasticAPM' \n      ], \n      elasticAPM: (function () { \n         return function (err, req, res, next) { \n            apm.middleware.connect(); \n            if (typeof err !== 'undefined') \n               apm.captureError(err); \n            return next(); \n         }; \n      })()\n   }    \n}; \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to  "),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on lef side bar -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h2",{id:"kubernetes"},"Kubernetes"),(0,i.kt)("h3",{id:"nodejs-express-1"},"Node.JS Express"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0  \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0"  \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"  and run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"app.js")),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n   }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in Kubernetes deployment file. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/"},"https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in Snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to: View dashboard -> Click on Tracing on left side bar   -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))))),(0,i.kt)("h3",{id:"nodejs-sails-1"},"Node.JS Sails"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0  \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"globals.js")," present in config folder. "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n   }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Attach apm object to globals \u2013 This is required so we can use apm variable in other files as part of global sails object"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.globals = { \n   _: require('@sailshq/lodash'), \n   async: false, \n   models: true, \n   sails: true, \n   apm : apm, \n   logger: logger \n}; \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Also add middleware in ",(0,i.kt)("inlineCode",{parentName:"p"},"http.js")," file present in config folder. Which allows to instrument our code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.http = {\n   middleware: { \n      order: [ \n         'elasticAPM' \n      ], \n      elasticAPM: (function () { \n         return function (err, req, res, next) { \n         apm.middleware.connect(); \n         if (typeof err !== 'undefined') \n            apm.captureError(err); \n         return next(); \n         }; \n      })() \n   }\n}; \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in Kubernetes deployment file. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/"},"https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/")," "),(0,i.kt)("p",{parentName:"li"},"If deploying with helm provide above variables in values.yaml and use them in deployment file of charts. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://phoenixnap.com/kb/helm-environment-variables"},"https://phoenixnap.com/kb/helm-environment-variables")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to  "),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on lef side bar -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h2",{id:"docker"},"Docker"),(0,i.kt)("h3",{id:"nodejs-express-2"},"Node.JS Express"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-docker"},"RUN npm install --save elastic-apm-node@^3.20.0 \nRUN npm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"}," And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"app.js")),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n   }) \n} catch (e) { \n   console.log(e); \n} \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," or docker stack deployment file or at command line when using docker run command for deployment. "),(0,i.kt)("p",{parentName:"li"},"Eg: "),(0,i.kt)("p",{parentName:"li"},"Docker-compose and stack: ",(0,i.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/environment-variables/"},"https://docs.docker.com/compose/environment-variables/")," "),(0,i.kt)("p",{parentName:"li"},"Docker run cli command: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-docker"},"docker run -d -t -i -e SF_PROJECT_NAME='<Project name>' \\  \n-e SF_APP_NAME='<SF_APP_NAME>' \\ \n-e SF_PROFILE_KEY='<snappyflow profile key>' \\ \n--name <container_name>  <dockerhub_id/image_name> \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"// Project related info "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in Snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to  "),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on lef side bar -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h3",{id:"nodejs-sails-2"},"Node.JS Sails"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-docker"},"RUN npm install --save elastic-apm-node@^3.20.0 \nRUN npm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"}," And run \u2018npm install\u2019 to install dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"globals.js")," present in config folder. "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true \n   }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Attach apm object to globals \u2013 This is required so we can use apm variable in other files as part of global sails object. "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.globals = { \n   _: require('@sailshq/lodash'), \n   async: false, \n   models: true, \n   sails: true, \n   apm : apm, \n   logger: logger \n}; \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Also add middleware in ",(0,i.kt)("inlineCode",{parentName:"p"},"http.js")," file present in config folder. Which allows to instrument our code. "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.http = { \n   middleware: { \n      order: [ \n         'elasticAPM' \n      ], \n      elasticAPM: (function () {  \n         return function (err, req, res, next) { \n         apm.middleware.connect(); \n         if (typeof err !== 'undefined') \n            apm.captureError(err); \n         return next(); \n         }; \n      })() \n   } \n}; \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," or docker stack deployment file or at command line when using docker run command for deployment. "),(0,i.kt)("p",{parentName:"li"},"Eg: "),(0,i.kt)("p",{parentName:"li"},"Docker-compose and stack: ",(0,i.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/environment-variables/"},"https://docs.docker.com/compose/environment-variables/")," "),(0,i.kt)("p",{parentName:"li"},"Docker run cli command: "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-docker"},"docker run -d -t -i -e SF_PROJECT_NAME='<SF_PROJECT_NAME>' \\  \n-e SF_APP_NAME='<SF_APP_NAME>' \\ \n-e SF_PROFILE_KEY='<snappyflow profile key>' \\ \n--name <container_name>  <dockerhub_id/image_name> \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to "),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on lef side bar -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h2",{id:"ecs"},"ECS"),(0,i.kt)("h3",{id:"nodejs-express-3"},"Node.JS Express"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0 \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initilization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"app.js")),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n   }) \n} catch (e) { \n   console.log(e); \n} \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in add container section of task definitions. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html"},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in Snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to: View dashboard -> Click on Tracing on left side bar   -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/refapp-express")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h3",{id:"nodejs-sails-3"},"Node.JS Sails"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install nodejs dependencies and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install --save elastic-apm-node@^3.20.0  \nnpm install --save sf-apm-lib@^1.0.2 \n")),(0,i.kt)("p",{parentName:"li"},"or update ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," file with following entries"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},'"elastic-apm-node": "^3.20.0" \n"sf-apm-lib": "^1.0.2" \n')),(0,i.kt)("p",{parentName:"li"},"And run ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install")," to install dependencies ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add initialization code at start of the file in ",(0,i.kt)("inlineCode",{parentName:"p"},"globals.js")," present in config folder. "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Get Snappyflow trace config using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const Snappyflow = require('sf-apm-lib'); \nvar sfObj = new Snappyflow(); // Initialize Snappyflow. By default intialization will take profileKey, projectName and appName from sfagent config.yaml.\n\n// Add below part to manually configure the initialization \nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \nsfObj.init(profileKey, projectName, appName); // Manual override\n\nlet sfTraceConfig = sfObj.getTraceConfig();\n\n// Start Trace to log feature section\n// Add below line of code to enable Trace to log feature:\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_redact_body=true'\n// Option Configs for trace to log\n// Add below line to provide custom documentType (Default:\"user-input\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_documentType=<document-type>'\n// Add below line to provide destination index (Default:\"log\"):\nsfTraceConfig['SFTRACE_GLOBAL_LABELS'] += ',_tag_IndexType=<index-type>' // Applicable values(log, metric)\n// End trace to log section\n\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Initialize apm object using"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"var apm; \ntry { \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME>', // Specify your service name for tracing \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n   }) \n} catch (e) { \n   console.log(e); \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Attach apm object to globals \u2013 This is required so we can use apm variable in other files as part of global sails object"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.globals = { \n   _: require('@sailshq/lodash'), \n   async: false, \n   models: true, \n   sails: true, \n   apm : apm, \n   logger: logger \n}; \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Also add middleware in ",(0,i.kt)("inlineCode",{parentName:"p"},"http.js")," file present in config folder. Which allows to instrument our code"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports.http = { \n   middleware: { \n      order: [ \n         'elasticAPM' \n      ], \n      elasticAPM: (function () { \n         return function (err, req, res, next) { \n            apm.middleware.connect(); \n            if (typeof err !== 'undefined') \n               apm.captureError(err); \n            return next(); \n         }; \n      })() \n   } \n}; \n"))))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Provide ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY")," as an environment variables in add container section of task definitions. "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html"},"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/taskdef-envfiles.html")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Once your server is up and running you can check trace in Snappyflow Server. "),(0,i.kt)("p",{parentName:"li"},"For viewing trace in snappyflow server make sure project and app name is created or discovered with project name and app name specified in point no.2 "),(0,i.kt)("p",{parentName:"li"},"Once project and app name is created go to  "),(0,i.kt)("p",{parentName:"li"},"View dashboard -> Click on Tracing on lef side bar -> Click on view transaction -> Go to real time tab ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"For complete code refer sample app refer at: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail"},"https://github.com/snappyflow/tracing-reference-apps/tree/master/RefappNodeSail")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("b",null,"Note"),": ",(0,i.kt)("i",null," 'captureBody':'all' config should be present in apm agent code instrumentation for Trace to Log feature. "))),(0,i.kt)("h2",{id:"aws-lambda"},"AWS Lambda"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Install dependency libraries in the node_modules directory using the\u202fnpm install\u202fcommand"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"npm install sf-apm-lib@^1.0.2 \nnpm install elastic-apm-node@^3.20.0 \n")),(0,i.kt)("p",{parentName:"li"},"Ref: ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/nodejs-package.html"},"https://docs.aws.amazon.com/lambda/latest/dg/nodejs-package.html")," ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Instrument lambda function to enable tracing "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add code outside lambda handler method to get tracing config and create trace client "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"// SnappyFlow Tracing config \nconst Snappyflow = require('sf-apm-lib');\n\nlet projectName = process.env.SF_PROJECT_NAME; \nlet appName = process.env.SF_APP_NAME; \nlet profileKey = process.env.SF_PROFILE_KEY; \n\nvar sfObj = new Snappyflow(); \nsfObj.init(profileKey, projectName, appName); \n\nvar apm; \ntry { \n   var sfTraceConfig = sfObj.getTraceConfig(); \n   apm = require('elastic-apm-node').start({ \n      serviceName: '<SERVICE_NAME_CHANGEME>', \n      serverUrl: sfTraceConfig['SFTRACE_SERVER_URL'], \n      globalLabels: sfTraceConfig['SFTRACE_GLOBAL_LABELS'], \n      verifyServerCert: sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'] === undefined ? false : sfTraceConfig['SFTRACE_VERIFY_SERVER_CERT'], \n      active: sfTraceConfig['SFTRACE_SERVER_URL'] === undefined ? false : true, \n      stackTraceLimit: sfTraceConfig['SFTRACE_STACK_TRACE_LIMIT'], \n      captureSpanStackTraces: sfTraceConfig['SFTRACE_CAPTURE_SPAN_STACK_TRACES'],\n      captureBody: 'all' ,\n      metricsInterval: '0s',\n      usePathAsTransactionName: true\n  }) \n} catch (e) { \n   console.log(e) \n} \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add custom instrumentation inside lambda handler method "),(0,i.kt)("p",{parentName:"li"},"Ref: ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-transactions.html"},"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-transactions.html")," "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-spans.html"},"https://www.elastic.co/guide/en/apm/agent/nodejs/current/custom-spans.html")," "),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"// Create custom transaction \nvar trans = apm.startTransaction('lambda handler', 'lambda');  \n//Create custom span is needed \nvar span = apm.startSpan('parse json'); \n// your CODE here \n// End of span \nif (span) span.end() \n//Some more code part of the transaction or add more spans here. Don\u2019t RETURN/EXIT  //end custom transaction \ntrans.result = 'success'; \ntrans.end();     \n// RETURN code \n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Deploy the lambda app. Follow README to test sample app "),(0,i.kt)("p",{parentName:"li"},"Reference app: "),(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/upendrasahu/aws-lambda-nodejs-tracing-sample"},"https://github.com/upendrasahu/aws-lambda-nodejs-tracing-sample"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure Lambda function before trigger/invoke. "),(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the environment variable\u202f",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROFILE_KEY"),"\u202fand set the value to your\u202fprofile key copied from SnappyFlow. ")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add environment variables ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_APP_NAME")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"SF_PROJECT_NAME")," with appropriate values. Create this Project and Application in SnappyFlow if not already present. "),(0,i.kt)("img",{src:"images\\nodejs_lambda_1.png"})))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"At this point you can trigger lambda function and get tracing data in SnappyFlow."))))),(0,i.kt)("h2",{id:"log-correlation"},"Log Correlation"),(0,i.kt)("p",null,"If you are using existing logger in your application then embed transaction id, trace id and span id using elastic apm node client object which was created at the start of the application. For more info refer apm initialization code."),(0,i.kt)("p",null,"Eg."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"   var traceId = 'None';\n   var transactionId = 'None';\n   var spanId = 'None';\n   if (typeof(apm) !== 'undefined') {\n\n      var apmTraceObj = apm.currentTraceIds; // Apm object having current trace ids\n      transactionId = apmTraceObj['transaction.id'] || 'None';\n      traceId = apmTraceObj['trace.id'] || 'None';\n      spanId = apmTraceObj['span.id'] || 'None';\n   }\n   var msg = `[${moment().format('DD/MMM/YYYY hh:mm:ss')}] [${level}] [${msg}] | elasticapm transaction.id=${transactionId} trace.id=${traceId} span.id=${spanId}\\n`\n")),(0,i.kt)("p",null,"For using Log correlation in application log file refer:\n",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/apm/agent/nodejs/current/log-correlation.html"},"https://www.elastic.co/guide/en/apm/agent/nodejs/current/log-correlation.html")),(0,i.kt)("h3",{id:"adding-custom-snappyflow-logger-for-log-correlation"},"Adding custom Snappyflow logger for log correlation"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"   //Copy logger file from snappyflow reference app to location where you want to put. Initialize logger in your app using following code:\n\n   const logger = require(\"./logger\").Logger;\n\n   logger.attachAPM(apm);\n   logger.setLogFilePath('/var/log/trace/ntrace.log');  //Put log file in /var/log/trace folder\n   logger.init();\n\n   //Write log \n   logger.debug('Hello world get api called')\n   logger.info('Hello world get api called')\n   logger.error('Some error ocurred')\n")),(0,i.kt)("p",null,"For code reference refer: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-express/logger.js"},"https://github.com/snappyflow/tracing-reference-apps/blob/master/refapp-express/logger.js")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"send-log-correlation-data-to-snappyflow-server"},"Send log correlation data to snappyflow server"),(0,i.kt)("p",null,"Below are the modes for sending log correlated data to snappyflow server"),(0,i.kt)("h3",{id:"-for-appliance-"},(0,i.kt)("b",null," For Appliance ")),(0,i.kt)("p",null,"Install sfagent and create config file."),(0,i.kt)("p",null,"Refer: ",(0,i.kt)("a",{parentName:"p",href:"https://docs.snappyflow.io/docs/Integrations/os/linux/sfagent_linux"},"https://docs.snappyflow.io/docs/Integrations/os/linux/sfagent_linux")),(0,i.kt)("p",null,"Add elasticApmLog plugin to sfagent config.yaml and restart sfagent service.\nEg. Config.yaml"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"key: <SF_PROFILE_KEY>\ntags:\n  Name: <any-name>\n  appName: <SF_APP_NAME>\n  projectName: <SF_PROJECT_NAME>\nlogging:\n  plugins:\n    - name: elasticApmTraceLog\n      enabled: true\n      config:\n         log_level:\n            - error\n            - warning\n            - info\n         log_path: /var/log/trace/ntrace.log  # Your app log file path\n")),(0,i.kt)("h3",{id:"-for-kubernetes-"},(0,i.kt)("b",null," For Kubernetes ")),(0,i.kt)("p",null,"Specify following values in metadata labels section of deployment file."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"snappyflow/appname: <SF_APP_NAME>\nsnappyflow/projectname: <SF_PROJECT_NAME>\nsnappyflow/component: gen-elastic-apm-log # This is must for tracing log correlation\n")),(0,i.kt)("h3",{id:"sample-deployment-file"},"Sample deployment file"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    io.kompose.service: express-node\n    snappyflow/appname: '<sf_app_name>'\n    snappyflow/projectname: '<sf_project_name>'\n    snappyflow/component: gen-elastic-apm-log\n  name: express-node\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      io.kompose.service: express-node\n  strategy: {}\n  template:\n    metadata:\n      labels:\n        io.kompose.service: express-node\n        snappyflow/appname: '<sf_app_name>'\n        snappyflow/projectname: '<sf_project_name>'\n        snappyflow/component: gen-elastic-apm-log\n    spec:\n      containers:\n        - env:\n            - name: SF_APP_NAME\n              value: '<sf_app_name>'\n            - name: SF_PROFILE_KEY\n              value: '<sf_profile_key>'\n            - name: SF_PROJECT_NAME\n              value: '<sf_project_name>'\n          image: refapp-node:latest\n          imagePullPolicy: Always\n          name: express-node\n          ports:\n            - containerPort: 3000\n          resources:\n            requests:\n              cpu: 10m\n              memory: 10Mi\n            limits:\n              cpu: 50m\n              memory: 50Mi\n      restartPolicy: Always\n")),(0,i.kt)("b",null,(0,i.kt)("i",null,"Note: For kubernetes mode we need sfagent pods to be running inside kubernetes cluster where your application pods are deployed.")),(0,i.kt)("p",null,"For viewing trace and logs in Snappyflow server make sure project and app name is created or discovered.\nOnce project and app name is created."),(0,i.kt)("p",null,"Go to: View App dashboard -> Click on Tracing on left side bar   -> Click on view transaction -> Go to real time tab\nThen click on any trace and go to logs tab to see the correlated logs to trace."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"// Note: To get trace in snappyflow server we need log entries to adhere following log format:\n<date in following format>\n[10/Aug/2021 10:51:16] [<log_level>] [<message>] | elasticapm transaction.id=<transaction_id> trace.id=<trace_id> span.id=<span_id>\n")))}f.isMDXComponent=!0}}]);